name: Django CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: todoapp_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Grant MySQL Permissions
      run: |
        mysql -h 127.0.0.1 -uroot -prootpassword -e "CREATE USER IF NOT EXISTS 'todoapp_user'@'%' IDENTIFIED BY 'todoapp_password';"
        mysql -h 127.0.0.1 -uroot -prootpassword -e "GRANT ALL PRIVILEGES ON *.* TO 'todoapp_user'@'%' WITH GRANT OPTION;"
        mysql -h 127.0.0.1 -uroot -prootpassword -e "FLUSH PRIVILEGES;"
    
    - name: Run migrations
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_PORT: 3306
        DATABASE_NAME: todoapp_db
        DATABASE_USER: todoapp_user
        DATABASE_PASSWORD: todoapp_password
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        python manage.py migrate
    
    - name: Run Bandit Security Check
      run: |
        bandit -r tasks/ todoapi/ -f txt || true
    
    - name: Run Flake8
      run: |
        flake8 tasks/ todoapi/ --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Run Unit Tests
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_PORT: 3306
        DATABASE_NAME: todoapp_db
        DATABASE_USER: todoapp_user
        DATABASE_PASSWORD: todoapp_password
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        echo "Running Unit Tests..."
        pytest tests/test_unit.py -v -m unit
    
    - name: Run Integration Tests
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_PORT: 3306
        DATABASE_NAME: todoapp_db
        DATABASE_USER: todoapp_user
        DATABASE_PASSWORD: todoapp_password
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        echo "Running Integration Tests..."
        pytest tests/test_integration.py -v -m integration
    
    - name: Run E2E Tests
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_PORT: 3306
        DATABASE_NAME: todoapp_db
        DATABASE_USER: todoapp_user
        DATABASE_PASSWORD: todoapp_password
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        echo "Running E2E Tests..."
        pytest tests/test_e2e.py -v -m e2e
    
    - name: Run All Tests with Coverage
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_PORT: 3306
        DATABASE_NAME: todoapp_db
        DATABASE_USER: todoapp_user
        DATABASE_PASSWORD: todoapp_password
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        pytest tests/ --cov=tasks --cov-report=xml --cov-report=term-missing
    
    - name: Final Success Message
      run: |
        echo "================================"
        echo "    âœ“ ALL CHECKS PASSED"
        echo "================================"
        echo "OK"